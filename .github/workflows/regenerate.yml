name: Regenerate Address Book

on:
  schedule:
    # Run every 6 hours to catch new deployments
    - cron: '0 */6 * * *'
  workflow_dispatch: # Allow manual trigger

# Explicit permissions for security (CodeQL requirement)
permissions:
  contents: write       # Required to push commits and create branches
  pull-requests: write  # Required to create pull requests

jobs:
  regenerate:
    name: Check and Regenerate Addresses
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Foundry
        # Using major version tag - foundry-toolchain needs frequent updates for security fixes
        # Maintained by official Foundry team: https://github.com/foundry-rs/foundry-toolchain
        uses: foundry-rs/foundry-toolchain@v1 # codeql[skip-reason:trusted-action-needs-updates]
        with:
          version: nightly

      - name: Install Python dependencies
        run: pip install -r scripts/requirements.txt

      - name: Get current hash
        id: before
        run: |
          HASH=$(grep "LZ_ADDRESSES_DATA_HASH" src/generated/LZAddresses.sol | grep -oE '0x[a-fA-F0-9]+' || echo "none")
          echo "hash=$HASH" >> $GITHUB_OUTPUT
          echo "Current hash: $HASH"

      - name: Regenerate addresses
        id: regenerate
        run: |
          echo "Fetching latest metadata from LayerZero API..."
          python3 scripts/lz-generate-addresses.py
          echo "Regeneration complete"

      - name: Get new hash
        id: after
        run: |
          HASH=$(grep "LZ_ADDRESSES_DATA_HASH" src/generated/LZAddresses.sol | grep -oE '0x[a-fA-F0-9]+' || echo "none")
          echo "hash=$HASH" >> $GITHUB_OUTPUT
          echo "New hash: $HASH"

      - name: Check for changes
        id: diff
        run: |
          if [ "${{ steps.before.outputs.hash }}" != "${{ steps.after.outputs.hash }}" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "Hash changed: ${{ steps.before.outputs.hash }} -> ${{ steps.after.outputs.hash }}"
          else
            # Also check for any file changes (in case hash logic changes)
            if git diff --quiet src/generated/; then
              echo "changed=false" >> $GITHUB_OUTPUT
              echo "No changes detected"
            else
              echo "changed=true" >> $GITHUB_OUTPUT
              echo "Files changed (hash unchanged)"
            fi
          fi

      - name: Get timestamp
        if: steps.diff.outputs.changed == 'true'
        id: timestamp
        run: echo "time=$(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_OUTPUT

      - name: Run tests
        if: steps.diff.outputs.changed == 'true'
        run: |
          echo "Running tests to verify regenerated code..."
          forge fmt
          forge build --sizes --ignore-eip-3860
          forge test -vvv --no-match-path "**/fork/**"
          echo "All tests passed"

      - name: Create Pull Request
        if: steps.diff.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'chore: regenerate address book from metadata API'
          title: 'chore: update LayerZero addresses'
          body: |
            ## Automated Address Book Update
            
            This PR was automatically generated by the address regeneration workflow.
            
            ### Changes Detected
            
            | Metric | Value |
            |--------|-------|
            | **Previous Hash** | `${{ steps.before.outputs.hash }}` |
            | **New Hash** | `${{ steps.after.outputs.hash }}` |
            | **Generated At** | `${{ steps.timestamp.outputs.time }}` |
            | **Workflow Run** | [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) |
            
            ### What Changed
            
            The LayerZero metadata API returned updated deployment information. This could include:
            - New chain deployments
            - Updated contract addresses
            - New DVN providers
            - Stargate pool updates
            
            ### Verification
            
            - [x] Code regenerated successfully
            - [x] All tests passed (`forge test --no-match-path "**/fork/**"`)
            - [x] Build succeeded (`forge build`)
            
            Please review the changes and merge if everything looks correct.
          branch: chore/auto-update-addresses
          delete-branch: true
          labels: |
            automated
            addresses
